<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laundry Tracker</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Montserrat:wght@400;500;600;700&family=Courier+New:wght@400&display=swap" rel="stylesheet">
    
    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .font-app-base {
            font-family: var(--app-font-family, 'Inter', sans-serif);
        }
        /* Style for the color input picker */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #9ca3af; /* gray-400 */
            border-radius: 50%;
        }
    </style>
</head>
<body class="font-app-base transition-colors duration-300">

    <div id="root"></div>

    <script type="text/babel">
        // --- API Configuration ---
        const API_URL = ' API Configuration URL';

        // --- Utility function in global scope ---
        const getTimeSince = (date) => {
            if (!date) return 'Never';
            const now = new Date();
            const diffInMs = now.getTime() - new Date(date).getTime();
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            if (diffInDays < 0) return 'In the future';
            if (diffInDays === 0) return 'Today';
            if (diffInDays === 1) return '1 day ago';
            return `${diffInDays} days ago`;
        };
        
        function compressImage(file, quality = 0.7, max_width = 1024, max_height = 1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > max_width) { height *= max_width / width; width = max_width; }
                        } else {
                            if (height > max_height) { width *= max_height / height; height = max_height; }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) { resolve(blob); } 
                            else { reject(new Error('Canvas to Blob conversion failed'));}
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }


        // --- Icon Components ---
        const Icon = ({ size = 24, className = '', children }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const AlertCircle = props => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></Icon>;
        const Plus = props => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const Trash = props => <Icon {...props}><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></Icon>;
        const Shirt = props => <Icon {...props}><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"></path></Icon>;
        const WashingMachine = props => <Icon {...props}><path d="M3 6h3"/><path d="M17 6h.01"/><rect width="18" height="20" x="3" y="2" rx="2"/><circle cx="12" cy="13" r="5"/><path d="M12 18v.01"/></Icon>;
        const RefreshCw = props => <Icon {...props}><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></Icon>;
        const ArrowDownWideNarrow = props => <Icon {...props}><path d="m3 16 4 4 4-4"></path><path d="M7 20V4"></path><path d="M11 4h10"></path><path d="M11 8h7"></path><path d="M11 12h4"></path></Icon>;
        const CalendarDays = props => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const Tag = props => <Icon {...props}><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.432 0l6.568-6.568a2.426 2.426 0 0 0 0-3.432l-8.704-8.704z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></Icon>;
        const List = props => <Icon {...props}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></Icon>;
        const Grid = props => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="3" x2="9" y2="21"></line></Icon>;
        const Settings = props => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const KeyRound = props => <Icon {...props}><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"></path><circle cx="16.5" cy="7.5" r=".5"></circle></Icon>;
        const Database = props => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></Icon>;
        const X = props => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const ArrowUp = props => <Icon {...props}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></Icon>;
        const ArrowDown = props => <Icon {...props}><path d="m5 12 7 7 7-7"/><path d="M12 5v14"/></Icon>;
        const Eye = props => <Icon {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const EyeOff = props => <Icon {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></Icon>;
        const Camera = props => <Icon {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>;
        const UploadCloud = props => <Icon {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></Icon>;
        const Link = props => <Icon {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></Icon>;
        const Palette = props => <Icon {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.667 0-.424-.16-.832-.435-1.155-.275-.323-.57-.69-.865-1.096v-2.59c.56-.318 1.155-.725 1.745-1.258.105-.095.21-.19.315-.29.27-.25.545-.49.825-.71C17.03 13.19 19 11.23 19 9c0-3.866-3.134-7-7-7z"/></Icon>;

        const { useState, useEffect, useCallback } = React;

        const LaundryItem = ({ item, onWear, onWash, onDelete }) => {
            const needsWashing = item.usage_count >= 3;
            const timeSinceWashed = getTimeSince(item.last_washed);
            const imageUrl = item.image_url && item.image_url.trim() !== '' && !item.image_url.includes('Image+Too+Large') ? item.image_url : `https://placehold.co/150x150/e2e8f0/1a202c?text=${encodeURIComponent((item.name || 'Item').substring(0, 3))}`;
            
            return (
                <div className={`p-4 rounded-xl flex items-center justify-between transition-colors duration-300 ${needsWashing ? 'bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700' : `bg-[var(--color-form-bg)] border-slate-200 dark:border-slate-700`} shadow-sm border`}>
                     <div className="flex-1 flex items-center space-x-3 sm:space-x-4">
                        <img src={imageUrl} alt={item.name} className="h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover bg-slate-100 dark:bg-slate-700 p-1" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/e2e8f0/1a202c?text=${encodeURIComponent((item.name || 'I').substring(0, 3))}` }} />
                        <div className="flex-1 space-y-0.5 min-w-0">
                            <h3 className={`text-base sm:text-lg font-semibold text-[var(--color-text-primary)] truncate`}>{item.name}</h3>
                            <div className={`flex flex-wrap items-center gap-x-2 text-xs sm:text-sm text-[var(--color-text-muted)]`}>
                                <span className="text-[var(--color-text-secondary)]">Worn: {item.usage_count} times</span>
                                <div className="px-1.5 py-0.5 rounded-full text-xs font-semibold flex items-center"><Tag size={12} className="inline mr-0.5" /> {item.category || 'Uncategorized'}</div>
                                <div className="flex items-center w-full sm:w-auto mt-0.5 sm:mt-0"><CalendarDays size={14} className="mr-1" /><span>Last Washed: {timeSinceWashed}</span></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-col space-y-2 sm:flex-row sm:space-x-2 sm:space-y-0 ml-2">
                        <button onClick={() => onWear(item)} className={`p-2 bg-[var(--color-button-primary)] text-[var(--color-button-text)] rounded-full hover:brightness-110 shadow-md`}><Plus size={18} /></button>
                        <button onClick={() => onWash(item)} className="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 shadow-md"><WashingMachine size={18} /></button>
                        <button onClick={() => onDelete(item)} className={`p-2 bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)] rounded-full shadow-md`}><Trash size={18} /></button>
                    </div>
                </div>
            );
        };

        const WardrobeItem = ({ item, onWear, onWash, onDelete }) => {
            const needsWashing = item.usage_count >= 3;
            const timeSinceWashed = getTimeSince(item.last_washed);
            const imageUrl = item.image_url && item.image_url.trim() !== '' ? item.image_url : `https://placehold.co/150x150/e2e8f0/1a202c?text=${encodeURIComponent((item.name || 'I').substring(0, 3))}`;

            return (
                <div className={`p-3 rounded-xl flex flex-col items-center text-center transition-colors duration-300 ${needsWashing ? 'bg-red-50 dark:bg-red-900 border-red-300 dark:border-red-700 shadow-lg ring-2 ring-red-500/50' : `bg-[var(--color-form-bg)] border-slate-200 dark:border-slate-700 shadow-md`} border`}>
                    <div className="relative">
                        <img src={imageUrl} alt={item.name} className="h-28 w-28 sm:h-32 sm:w-32 rounded-xl object-contain bg-white dark:bg-slate-700 p-1 border-2 border-slate-200 dark:border-slate-700" onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/150x150/e2e8f0/1a202c?text=${encodeURIComponent((item.name || 'I').substring(0, 3))}` }}/>
                        {needsWashing && <div className="absolute top-0 right-0 p-1 bg-red-500 text-white rounded-full translate-x-1 -translate-y-1 shadow-lg"><AlertCircle size={14} /></div>}
                    </div>
                    <h3 className={`text-sm font-semibold text-[var(--color-text-primary)] mt-2 truncate w-full px-1`}>{item.name}</h3>
                    <div className={`text-[var(--color-text-muted)] text-xs mt-1 space-y-0.5`}>
                        <p className="font-medium">Worn: {item.usage_count}</p>
                        <p className="italic">Washed: {timeSinceWashed}</p>
                    </div>
                    <div className="flex space-x-2 mt-3">
                        <button onClick={() => onWear(item)} className={`p-2 bg-[var(--color-button-primary)] text-[var(--color-button-text)] rounded-full hover:brightness-110 shadow-md`}><Plus size={16} /></button>
                        <button onClick={() => onWash(item)} className="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 shadow-md"><WashingMachine size={16} /></button>
                        <button onClick={() => onDelete(item)} className={`p-2 bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)] rounded-full shadow-md`}><Trash size={16} /></button>
                    </div>
                </div>
            );
        };

        const CategoryRow = ({ category, items, onWear, onWash, onDelete }) => {
            if (!items || items.length === 0) return null;
            return (
                <div className="space-y-3 pb-6">
                    <h4 className={`text-xl font-bold text-[var(--color-text-primary)] flex items-center`}>
                        <Tag size={20} className={`mr-2 text-[var(--color-accent)]`} />
                        {category} ({items.length})
                    </h4>
                    <div className="flex overflow-x-auto space-x-4 pb-2 -mx-4 px-4 sm:px-0">
                        {items.map((item) => (
                            <div key={item.id} className="flex-shrink-0 w-44 sm:w-48">
                                <WardrobeItem item={item} onWear={onWear} onWash={onWash} onDelete={onDelete} />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const ConfirmationModal = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl space-y-4 w-full max-w-sm border border-slate-300 dark:border-slate-700">
                    <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100 flex items-center">
                        <AlertCircle size={24} className="text-red-500 mr-2" /> Confirm Action
                    </h3>
                    <p className="text-slate-600 dark:text-slate-400">{message}</p>
                    <div className="flex justify-end space-x-3">
                        <button className="p-3 rounded-xl bg-slate-300 font-semibold" onClick={onCancel}>Cancel</button>
                        <button className="p-3 rounded-xl bg-red-500 text-white font-semibold" onClick={onConfirm}>Delete</button>
                    </div>
                </div>
            </div>
        );


        // --- Main App Component ---
        const App = () => {
            const defaultTheme = {
                bg: '#f1f5f9', mainCard: '#e2e8f0', textPrimary: '#1e293b',
                textSecondary: '#475569', buttonPrimary: '#4f46e5', accent: '#6366f1'
            };

            const [laundryItems, setLaundryItems] = useState([]);
            const [itemName, setItemName] = useState('');
            const [itemImageUrl, setItemImageUrl] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('Shirts');
            const [newCategoryName, setNewCategoryName] = useState('');
            const [customCategories, setCustomCategories] = useState([]);
            const [sortBy, setSortBy] = useState('usage');
            const [userId, setUserId] = useState(null);
            const [dataKey, setDataKey] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isWardrobeView, setIsWardrobeView] = useState(true);
            const [showWashModal, setShowWashModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [newWashDate, setNewWashDate] = useState('');
            const [sharedKeyInput, setSharedKeyInput] = useState('');
            const [isCompressing, setIsCompressing] = useState(false);
            const [imageError, setImageError] = useState('');
            const [showAddItemForm, setShowAddItemForm] = useState(false);
            
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [isSyncing, setIsSyncing] = useState(false);
            const [pendingQueue, setPendingQueue] = useState([]);
            
            const [appName, setAppName] = useState('Laundry Tracker');
            const [appCaption, setAppCaption] = useState('Track clothes usage to know when to wash them.');
            const [customTheme, setCustomTheme] = useState(defaultTheme);
            const [fontFamily, setFontFamily] = useState('Inter, sans-serif');
            
            const [selectedCategoryFilter, setSelectedCategoryFilter] = useState('All');
            const [displayCategoryOrder, setDisplayCategoryOrder] = useState([]);
            
            const availableFonts = [
                { name: 'Inter (Default)', style: 'Inter, sans-serif' }, { name: 'Roboto', style: 'Roboto, sans-serif' },
                { name: 'Open Sans', style: 'Open Sans, sans-serif' }, { name: 'Montserrat', style: 'Montserrat, sans-serif' },
                { name: 'Courier New', style: 'Courier New, monospace' },
            ];
            
            const defaultCategories = ['Shirts', 'Pants', 'Nightwear', 'Innerwear', 'Towels', 'Bedsheets', 'Handkerchiefs'];
            const allCategories = [...defaultCategories, ...customCategories].filter((v, i, a) => a.indexOf(v) === i);

            const saveCustomization = (newSettings) => {
                const currentSettings = { appName, appCaption, customTheme, fontFamily };
                const mergedSettings = { ...currentSettings, ...newSettings };
                localStorage.setItem('appCustomization', JSON.stringify(mergedSettings));
                if (newSettings.appName !== undefined) setAppName(newSettings.appName);
                if (newSettings.appCaption !== undefined) setAppCaption(newSettings.appCaption);
                if (newSettings.customTheme !== undefined) setCustomTheme(newSettings.customTheme);
                if (newSettings.fontFamily !== undefined) setFontFamily(newSettings.fontFamily);
            };
            
            const handleThemeChange = (key, value) => {
                const newTheme = { ...customTheme, [key]: value };
                setCustomTheme(newTheme);
                saveCustomization({ customTheme: newTheme });
            };

            const resetTheme = () => {
                setCustomTheme(defaultTheme);
                saveCustomization({ customTheme: defaultTheme });
            };
            
            const fetchAndSetData = useCallback(async (key) => {
                if (!key) return;
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}?action=getData&data_key=${key}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if (data.success) {
                        setLaundryItems(data.items || []);
                        setCustomCategories(data.categories ? data.categories.map(c => c.name) : []);
                        localStorage.setItem('laundryTrackerCache', JSON.stringify({ items: data.items, categories: data.categories.map(c => c.name) }));
                    } else { throw new Error(data.error); }
                } catch (error) { 
                    console.error('Failed to fetch data, loading from cache.', error);
                    const cachedData = localStorage.getItem('laundryTrackerCache');
                    if(cachedData) {
                        const { items, categories } = JSON.parse(cachedData);
                        setLaundryItems(items || []);
                        setCustomCategories(categories || []);
                    }
                } finally { setLoading(false); }
            }, []);

            const syncOfflineChanges = useCallback(async () => {
                if (isSyncing) return;
                let queue = JSON.parse(localStorage.getItem('laundryTrackerOfflineQueue') || '[]');
                if (queue.length === 0) return;
                setIsSyncing(true);
                let failed = false;
                while (queue.length > 0) {
                    const action = queue[0];
                    const { type, payload } = action;
                    const success = await handleApiRequest(type, payload, true);
                    if (success) {
                        queue.shift();
                        localStorage.setItem('laundryTrackerOfflineQueue', JSON.stringify(queue));
                        setPendingQueue(current => current.slice(1));
                    } else {
                        console.error("Sync failed for action, will retry later:", action);
                        failed = true;
                        break;
                    }
                }
                setIsSyncing(false);
                if (!failed) await fetchAndSetData(dataKey);
            }, [dataKey, isSyncing]);

            useEffect(() => {
                const handleOnline = () => { setIsOnline(true); syncOfflineChanges(); };
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                if (navigator.onLine) syncOfflineChanges();
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [syncOfflineChanges]);

            useEffect(() => {
                let localUserId = localStorage.getItem('laundryTrackerUserId');
                if (!localUserId) {
                    localUserId = crypto.randomUUID();
                    localStorage.setItem('laundryTrackerUserId', localUserId);
                }
                setUserId(localUserId);
                const key = localStorage.getItem('sharedDataKey') || localUserId;
                setDataKey(key);
                setSharedKeyInput(key);

                const savedQueue = localStorage.getItem('laundryTrackerOfflineQueue');
                if (savedQueue) setPendingQueue(JSON.parse(savedQueue));

                const storedCustomization = localStorage.getItem('appCustomization');
                if (storedCustomization) {
                    try {
                        const custom = JSON.parse(storedCustomization);
                        setAppName(custom.appName || 'Laundry Tracker');
                        setAppCaption(custom.appCaption || 'Track clothes usage');
                        setCustomTheme(custom.customTheme || defaultTheme);
                        setFontFamily(custom.fontFamily || 'Inter, sans-serif');
                    } catch (e) { console.error("Error parsing customization", e); }
                }
            }, []);

            useEffect(() => { if (dataKey) { fetchAndSetData(dataKey); } }, [dataKey, fetchAndSetData]);

            useEffect(() => {
                const storedOrder = JSON.parse(localStorage.getItem('categoryDisplayOrder'));
                const currentCategories = ['Uncategorized', ...allCategories];
                if (storedOrder) {
                    const mergedOrder = [
                        ...storedOrder.filter(cat => currentCategories.includes(cat.name)),
                        ...currentCategories.filter(cat => !storedOrder.map(o => o.name).includes(cat)).map(cat => ({ name: cat, visible: true }))
                    ];
                    setDisplayCategoryOrder(mergedOrder);
                } else {
                    const initialOrder = currentCategories.map(cat => ({ name: cat, visible: true }));
                    setDisplayCategoryOrder(initialOrder);
                    localStorage.setItem('categoryDisplayOrder', JSON.stringify(initialOrder));
                }
            }, [allCategories.length]);
            
            const handleApiRequest = async (action, body, isSync = false) => {
                try {
                    const response = await fetch(`${API_URL}?action=${action}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                    });
                    if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
                    const result = await response.json();
                    if (result.success) return true;
                    else { 
                        console.error(`API error (${action}):`, result.error); 
                        if (!isSync) await fetchAndSetData(dataKey);
                        return false; 
                    }
                } catch (error) { 
                    console.error(`Network error (${action}):`, error.message); 
                    if (!isSync) await fetchAndSetData(dataKey);
                    return false; 
                }
            };
            
            const addToOfflineQueue = (action) => {
                const newQueue = [...pendingQueue, action];
                setPendingQueue(newQueue);
                localStorage.setItem('laundryTrackerOfflineQueue', JSON.stringify(newQueue));
            };
            
            const addItem = async (e) => {
                e.preventDefault();
                if (!itemName.trim() || !dataKey) return;
                const newItem = {
                    id: crypto.randomUUID(), dataKey, name: itemName.trim(), category: selectedCategory,
                    image_url: itemImageUrl, usage_count: 0, last_washed: new Date().toISOString()
                };
                setLaundryItems(prev => [...prev, newItem]);
                setItemName(''); setItemImageUrl(''); setImageError(''); setShowAddItemForm(false);
                const payload = {
                     id: newItem.id, dataKey, name: newItem.name, category: newItem.category,
                     imageData: itemImageUrl.startsWith('data:image') ? itemImageUrl : '',
                     imageUrl: !itemImageUrl.startsWith('data:image') ? itemImageUrl : '',
                };
                if (!isOnline) { addToOfflineQueue({ type: 'addItem', payload }); } 
                else { handleApiRequest('addItem', payload, false); }
            };

            const addCategory = (e) => {
                e.preventDefault();
                if (!newCategoryName.trim() || !dataKey) return;
                const newCatName = newCategoryName.trim();
                const payload = { dataKey, name: newCatName };
                setCustomCategories(prev => [...prev, newCatName].filter((v,i,a)=>a.indexOf(v)===i));
                setNewCategoryName('');
                if (!isOnline) { addToOfflineQueue({ type: 'addCategory', payload }); } 
                else { handleApiRequest('addCategory', payload, false); }
            };

            const wearItem = (itemToUpdate) => {
                setLaundryItems(prev => prev.map(item => item.id === itemToUpdate.id ? { ...item, usage_count: (Number(item.usage_count) || 0) + 1 } : item ));
                const payload = { id: itemToUpdate.id, dataKey, updates: { usageCount: (Number(itemToUpdate.usage_count) || 0) + 1 } };
                if(!isOnline) { addToOfflineQueue({ type: 'updateItem', payload }); } 
                else { handleApiRequest('updateItem', payload, false); }
            };

            const washItem = async () => {
                if (!selectedItem) return;
                const payload = { id: selectedItem.id, dataKey, updates: { usageCount: 0, lastWashed: new Date(newWashDate).toISOString() } };
                setLaundryItems(prev => prev.map(item => item.id === selectedItem.id ? { ...item, usage_count: 0, last_washed: new Date(newWashDate).toISOString() } : item ));
                setShowWashModal(false);
                setSelectedItem(null);
                if(!isOnline) { addToOfflineQueue({ type: 'updateItem', payload }); }
                else { handleApiRequest('updateItem', payload, false); }
            };

            const deleteItem = async () => {
                if (!selectedItem) return;
                const payload = { id: selectedItem.id, dataKey };
                setLaundryItems(prev => prev.filter(item => item.id !== selectedItem.id));
                setShowDeleteModal(false);
                setSelectedItem(null);
                if(!isOnline) { addToOfflineQueue({ type: 'deleteItem', payload }); }
                else { handleApiRequest('deleteItem', payload, false); }
            };

            const openWashModal = (item) => {
                setSelectedItem(item);
                const date = item.last_washed ? new Date(item.last_washed) : new Date();
                setNewWashDate(date.toISOString().substring(0, 10));
                setShowWashModal(true);
            };

            const openDeleteModal = (item) => { setSelectedItem(item); setShowDeleteModal(true); };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) {
                    setImageError("No photo was captured. Please try again.");
                    e.target.value = null; 
                    return;
                }
                setIsCompressing(true);
                setItemImageUrl('');
                setImageError('');
                const MAX_SIZE = 2 * 1024 * 1024;
                try {
                    let imageBlob = file;
                    if (file.size > MAX_SIZE) { imageBlob = await compressImage(file); }
                    if (imageBlob.size > MAX_SIZE) { setImageError("Image too large (max 2MB), even after compression."); return; }
                    const reader = new FileReader();
                    reader.onloadend = () => setItemImageUrl(reader.result);
                    reader.readAsDataURL(imageBlob);
                } catch (error) {
                    console.error("Image processing failed:", error);
                    setImageError("There was an error processing the image. Please try another file.");
                } finally {
                    setIsCompressing(false);
                    e.target.value = null;
                }
            };
            
            const setSharedKey = (e) => {
                e.preventDefault();
                const key = sharedKeyInput.trim();
                if (key.length < 4) return;
                localStorage.setItem('sharedDataKey', key);
                setDataKey(key);
                setShowSettingsModal(false);
            };

            const clearSharedKey = () => {
                localStorage.removeItem('sharedDataKey');
                setDataKey(userId);
                setSharedKeyInput(userId);
                setShowSettingsModal(false);
            };
            
            useEffect(() => {
                const root = document.documentElement;
                root.style.setProperty('--color-bg', customTheme.bg);
                root.style.setProperty('--color-main-card', customTheme.mainCard);
                root.style.setProperty('--color-text-primary', customTheme.textPrimary);
                root.style.setProperty('--color-text-secondary', customTheme.textSecondary);
                root.style.setProperty('--color-button-primary', customTheme.buttonPrimary);
                root.style.setProperty('--color-accent', customTheme.accent);
                root.style.setProperty('--color-button-text', '#ffffff'); 
                root.style.setProperty('--color-button-secondary', '#e2e8f0'); 
                root.style.setProperty('--color-button-secondary-text', '#1e293b');
                root.style.setProperty('--color-form-bg', '#ffffff');
                root.style.setProperty('--color-input-bg', '#f8fafc'); 
                document.body.style.backgroundColor = customTheme.bg;
                document.documentElement.style.setProperty('--app-font-family', fontFamily);
            }, [customTheme, fontFamily]);

            const sortedItems = [...laundryItems].sort((a, b) => {
                if (sortBy === 'date') return (new Date(b.last_washed) || 0) - (new Date(a.last_washed) || 0);
                if (sortBy === 'usage') return Number(b.usage_count) - Number(a.usage_count);
                return (a.name || '').localeCompare(b.name || '');
            });
            const filteredItems = selectedCategoryFilter === 'All' ? sortedItems : sortedItems.filter(item => (item.category || 'Uncategorized') === selectedCategoryFilter);
            const itemsByCategory = sortedItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});
            const categoriesToDisplay = displayCategoryOrder.filter(order => order.visible && (itemsByCategory[order.name] || []).length > 0);
            
            return (
                <div className="min-h-screen p-4 sm:p-6 flex flex-col items-center transition-colors duration-300 font-app-base">
                    <div className="w-full max-w-2xl bg-[var(--color-main-card)] p-4 sm:p-6 rounded-3xl shadow-2xl space-y-6 border border-black/10">
                        <header className="text-center space-y-1">
                            <h1 className={`text-3xl sm:text-5xl font-extrabold text-[var(--color-text-primary)]`}>{appName}</h1>
                            <p className={`text-base sm:text-xl text-[var(--color-text-secondary)]`}>{appCaption}</p>
                             <div className="pt-2 flex justify-center items-center space-x-4 text-xs font-semibold">
                                {!isOnline && <div className="bg-yellow-500 text-white px-3 py-1 rounded-full shadow">Offline Mode</div>}
                                {isSyncing && <div className="bg-blue-500 text-white px-3 py-1 rounded-full shadow flex items-center"><RefreshCw size={14} className="animate-spin mr-2"/> Syncing...</div>}
                                {!isOnline && pendingQueue.length > 0 && <div className="bg-gray-500 text-white px-3 py-1 rounded-full shadow">{pendingQueue.length} pending change(s)</div>}
                            </div>
                        </header>

                        <div className="flex justify-between space-x-2">
                            <button onClick={() => setShowSettingsModal(true)} className="p-3 rounded-full bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)] hover:brightness-95 shadow-md"><Settings size={20} /></button>
                            <div className="flex space-x-2">
                                <button onClick={() => setIsWardrobeView(false)} className={`p-3 rounded-full shadow-md ${!isWardrobeView ? 'bg-[var(--color-button-primary)] text-[var(--color-button-text)]' : 'bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)]'}`}><List size={20} /></button>
                                <button onClick={() => setIsWardrobeView(true)} className={`p-3 rounded-full shadow-md ${isWardrobeView ? 'bg-[var(--color-button-primary)] text-[var(--color-button-text)]' : 'bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)]'}`}><Grid size={20} /></button>
                            </div>
                        </div>

                        <div className="flex overflow-x-auto space-x-3 pb-2 pt-1 border-b border-black/10 -mx-4 px-4 sm:mx-0 sm:px-0">
                            <button onClick={() => setSelectedCategoryFilter('All')} className={`flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm ${selectedCategoryFilter === 'All' ? 'bg-[var(--color-button-primary)] text-[var(--color-button-text)]' : 'bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)]'}`}>All ({laundryItems.length})</button>
                            {allCategories.map(cat => {
                                const count = laundryItems.filter(item => (item.category || 'Uncategorized') === cat).length;
                                if (count === 0) return null;
                                return <button key={cat} onClick={() => setSelectedCategoryFilter(cat)} className={`flex-shrink-0 px-4 py-2 rounded-full font-semibold text-sm ${selectedCategoryFilter === cat ? 'bg-[var(--color-button-primary)] text-[var(--color-button-text)]' : 'bg-[var(--color-button-secondary)] text-[var(--color-button-secondary-text)]'}`}>{cat} ({count})</button>;
                            })}
                        </div>
                        
                        {!isWardrobeView ? (
                             <div className="flex items-center justify-between p-2 rounded-xl bg-[var(--color-button-secondary)] shadow-inner">
                                <div className={`flex items-center space-x-2 font-semibold text-[var(--color-text-primary)]`}><ArrowDownWideNarrow size={18} /><span>Sort by:</span></div>
                                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className={`p-2 rounded-lg bg-[var(--color-input-bg)] border border-black/10`}>
                                    <option value="usage">Usage Count</option>
                                    <option value="date">Last Washed</option>
                                </select>
                            </div>
                        ) : (
                            <div className="bg-[var(--color-form-bg)] rounded-xl shadow-inner border border-black/10">
                                {!showAddItemForm ? (
                                    <button onClick={() => setShowAddItemForm(true)} className={`w-full p-4 flex items-center justify-center font-semibold text-[var(--color-accent)]`}>
                                        <Plus size={20} className="mr-2"/> Add New Item to Wardrobe
                                    </button>
                                ) : (
                                     <form onSubmit={addItem} className="relative flex flex-col space-y-4 p-4">
                                        {isCompressing && (
                                            <div className="absolute inset-0 bg-white/90 dark:bg-slate-800/90 flex flex-col items-center justify-center rounded-xl z-10">
                                                <RefreshCw size={40} className="animate-spin text-[var(--color-accent)]" />
                                                <p className={`mt-3 text-sm font-semibold text-[var(--color-accent)]`}>Compressing image...</p>
                                            </div>
                                        )}
                                        <div className="flex justify-between items-center">
                                            <h4 className={`text-lg font-semibold text-[var(--color-text-primary)]`}>Add New Item</h4>
                                            <button type="button" onClick={() => setShowAddItemForm(false)} className={`text-sm font-semibold text-[var(--color-text-secondary)] hover:text-red-500`}>Cancel</button>
                                        </div>
                                        <input type="text" value={itemName} onChange={(e) => setItemName(e.target.value)} placeholder="Item Name (e.g., Blue T-Shirt)" required className={`p-3 rounded-xl bg-[var(--color-input-bg)] border border-black/10`} />
                                        <div className={`space-y-3 p-3 bg-[var(--color-input-bg)] rounded-xl border border-dashed border-black/20`}>
                                          <div className='flex justify-between items-center'>
                                            <p className={`text-sm font-medium text-[var(--color-text-secondary)]`}>Image</p>
                                            {itemImageUrl && <button type="button" onClick={() => { setItemImageUrl(''); setImageError(''); }} className="text-xs text-red-500 hover:text-red-700 flex items-center"><X size={14} /> Remove</button>}
                                          </div>
                                          <div className='grid grid-cols-3 gap-3'>
                                            <label className="cursor-pointer"><input type="file" accept="image/*" capture="camera" className="hidden" onChange={handleImageUpload} /><div className="p-3 rounded-xl text-center bg-indigo-200 text-indigo-800 h-full flex flex-col items-center justify-center"><Camera size={20} /><span className="text-xs mt-1">Take Photo</span></div></label>
                                            <label className="cursor-pointer"><input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} /><div className="p-3 rounded-xl text-center bg-green-200 text-green-800 h-full flex flex-col items-center justify-center"><UploadCloud size={20} /><span className="text-xs mt-1">Upload</span></div></label>
                                            <div className="flex items-center space-x-2 bg-white p-2 rounded-xl border"><Link size={20} className="text-slate-500" /><input type="text" value={itemImageUrl} onChange={(e) => { setItemImageUrl(e.target.value); setImageError(''); }} placeholder="Paste URL" className="w-full bg-transparent text-sm" /></div>
                                          </div>
                                          {itemImageUrl && <div className="mt-2 flex justify-center"><img src={itemImageUrl} alt="Preview" className="max-h-24 rounded-lg" /></div>}
                                          {imageError && <p className="text-center text-red-500 text-sm font-semibold mt-2">{imageError}</p>}
                                        </div>
                                        <select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className={`p-3 rounded-xl bg-[var(--color-input-bg)] border border-black/10`}>
                                            {allCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                        <button type="submit" disabled={!itemName.trim()} className={`p-3 rounded-xl font-semibold bg-[var(--color-button-primary)] text-[var(--color-button-text)] disabled:bg-slate-400`}><Plus size={20} className="inline mr-2"/>Add Item</button>
                                    </form>
                                )}
                            </div>
                        )}

                        {loading ? <div className="text-center p-8"><WashingMachine size={48} className="mx-auto animate-spin" /> <p className="mt-4">Loading laundry...</p></div>
                            : (filteredItems.length === 0 && selectedCategoryFilter === 'All') ? <div className="text-center p-8 bg-slate-100 rounded-xl"><AlertCircle size={48} className="mx-auto text-yellow-500" /><p className="mt-4 font-bold">Your wardrobe is empty!</p><p>Add a new item to get started.</p></div>
                            : (filteredItems.length === 0) ? <div className="text-center p-8 bg-slate-100 rounded-xl"><AlertCircle size={48} className="mx-auto text-yellow-500" /><p className="mt-4 font-bold">No items in '{selectedCategoryFilter}'</p></div>
                            : <div className="space-y-4">
                                {isWardrobeView && selectedCategoryFilter === 'All' ? (
                                    <div className="space-y-6">
                                        {categoriesToDisplay.map(catData => <CategoryRow key={catData.name} category={catData.name} items={itemsByCategory[catData.name]} onWear={wearItem} onWash={openWashModal} onDelete={openDeleteModal} />)}
                                    </div>
                                ) : isWardrobeView ? (
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                        {filteredItems.map(item => <WardrobeItem key={item.id} item={item} onWear={wearItem} onWash={openWashModal} onDelete={openDeleteModal} />)}
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {filteredItems.map(item => <LaundryItem key={item.id} item={item} onWear={wearItem} onWash={openWashModal} onDelete={openDeleteModal} />)}
                                    </div>
                                )}
                            </div>
                        }

                        {showWashModal && <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm"><div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-sm"><h3 className="text-xl font-bold flex items-center"><WashingMachine size={24} className="text-green-500 mr-2"/>Mark as Washed</h3><p>Date you washed "{selectedItem.name}":</p><input type="date" value={newWashDate} onChange={e => setNewWashDate(e.target.value)} className="w-full p-3 rounded-xl mt-2 border" /><div className="flex justify-end space-x-3 mt-4"><button className="p-3 rounded-xl bg-slate-300 font-semibold" onClick={() => setShowWashModal(false)}>Cancel</button><button className="p-3 rounded-xl bg-green-500 text-white font-semibold" onClick={washItem}>Confirm</button></div></div></div>}
                        {showDeleteModal && <ConfirmationModal message={`Delete "${selectedItem.name}"? This is permanent.`} onConfirm={deleteItem} onCancel={() => setShowDeleteModal(false)} />}
                        {showSettingsModal && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-md max-h-[90vh] overflow-y-auto space-y-6">
                                    <div className="flex justify-between items-center"><h3 className="text-2xl font-bold">Settings</h3><button onClick={() => setShowSettingsModal(false)} className="p-2 rounded-full bg-slate-200 dark:bg-slate-700"><X/></button></div>
                                    
                                    <div className="space-y-4 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl border">
                                        <h4 className="font-semibold flex items-center text-pink-600"><Palette size={20} className="mr-2"/>App Customization</h4>
                                        <label className="block"><span className="text-sm font-medium">App Name</span><input type="text" value={appName} onChange={e=>setAppName(e.target.value)} onBlur={e=>saveCustomization({appName:e.target.value})} className="w-full p-2 rounded-lg mt-1"/></label>
                                        <label className="block"><span className="text-sm font-medium">Caption</span><input type="text" value={appCaption} onChange={e=>setAppCaption(e.target.value)} onBlur={e=>saveCustomization({appCaption:e.target.value})} className="w-full p-2 rounded-lg mt-1"/></label>
                                        
                                        <div className="space-y-2">
                                            <span className="text-sm font-medium">Custom Theme</span>
                                            <div className="grid grid-cols-2 gap-4">
                                                <label className="flex items-center justify-between"><span className="mr-2">Background</span><input type="color" value={customTheme.bg} onChange={e => handleThemeChange('bg', e.target.value)}/></label>
                                                <label className="flex items-center justify-between"><span className="mr-2">Main Card</span><input type="color" value={customTheme.mainCard} onChange={e => handleThemeChange('mainCard', e.target.value)}/></label>
                                                <label className="flex items-center justify-between"><span className="mr-2">Primary Text</span><input type="color" value={customTheme.textPrimary} onChange={e => handleThemeChange('textPrimary', e.target.value)}/></label>
                                                <label className="flex items-center justify-between"><span className="mr-2">Secondary Text</span><input type="color" value={customTheme.textSecondary} onChange={e => handleThemeChange('textSecondary', e.target.value)}/></label>
                                                <label className="flex items-center justify-between"><span className="mr-2">Primary Button</span><input type="color" value={customTheme.buttonPrimary} onChange={e => handleThemeChange('buttonPrimary', e.target.value)}/></label>
                                                <label className="flex items-center justify-between"><span className="mr-2">Accent</span><input type="color" value={customTheme.accent} onChange={e => handleThemeChange('accent', e.target.value)}/></label>
                                            </div>
                                            <button onClick={resetTheme} className="w-full text-sm mt-2 p-2 bg-slate-200 rounded-lg">Reset to Default Colors</button>
                                        </div>

                                        <label className="block"><span className="text-sm font-medium">Font</span><select value={fontFamily} onChange={e=>saveCustomization({fontFamily:e.target.value})} className="w-full p-2 rounded-lg mt-1">{availableFonts.map(f=><option key={f.name} value={f.style}>{f.name}</option>)}</select></label>
                                    </div>

                                    <div className="space-y-4 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl border">
                                        <h4 className="font-semibold flex items-center"><KeyRound size={20} className="mr-2"/> Shared Data Key</h4>
                                        <form onSubmit={setSharedKey} className="space-y-2">
                                            <input value={sharedKeyInput} onChange={e => setSharedKeyInput(e.target.value)} className="w-full p-2 border rounded-lg" />
                                            <button type="submit" className="w-full p-2 bg-indigo-600 text-white rounded-lg">Set Key</button>
                                        </form>
                                        <button onClick={clearSharedKey} className="w-full p-2 bg-slate-300 rounded-lg">Revert to Private</button>
                                    </div>
                                    
                                    <div className="space-y-3 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl border">
                                        <h4 className="text-xl font-semibold">Add New Category</h4>
                                        <form onSubmit={addCategory} className="flex space-x-2">
                                            <input value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="Category Name" className="flex-1 p-3 rounded-xl border" />
                                            <button type="submit" disabled={!newCategoryName.trim()} className="p-3 rounded-xl bg-green-600 text-white disabled:bg-slate-400"><Plus /></button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

</body>
</html>

